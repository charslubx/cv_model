# å®Œæ•´èåˆè®­ç»ƒæŒ‡å—

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•ä½¿ç”¨å®Œæ•´èåˆçš„æ··åˆæ•°æ®é›†è®­ç»ƒç³»ç»Ÿï¼ŒåŸºäºç°æœ‰çš„ `training.py` è¿›è¡ŒDeepFashionå’ŒTextileNetæ•°æ®é›†çš„æ··åˆè®­ç»ƒã€‚

## ğŸ¯ åŠŸèƒ½ç‰¹ç‚¹

### 1. å®Œæ•´èåˆ
- åŸºäºç°æœ‰çš„ `training.py` æ–‡ä»¶ï¼Œå®Œå…¨èåˆæ··åˆæ•°æ®é›†åŠŸèƒ½
- ä¿æŒåŸæœ‰è®­ç»ƒæ¡†æ¶çš„ç¨³å®šæ€§å’Œå¯é æ€§
- æ— ç¼é›†æˆDeepFashionå’ŒTextileNetæ•°æ®é›†

### 2. æ™ºèƒ½æ•°æ®é›†æ£€æµ‹
- è‡ªåŠ¨æ£€æµ‹å¯ç”¨çš„æ•°æ®é›†
- æ”¯æŒéƒ¨åˆ†æ•°æ®é›†ç¼ºå¤±çš„æƒ…å†µ
- åŠ¨æ€è°ƒæ•´è®­ç»ƒç­–ç•¥

### 3. å¤šä»»åŠ¡å­¦ä¹ 
- DeepFashionå±æ€§åˆ†ç±»
- Fabricé¢æ–™åˆ†ç±»
- Fiberçº¤ç»´åˆ†ç±»
- å¯é€‰çš„åˆ†å‰²ä»»åŠ¡

## ğŸ“ æ–‡ä»¶ç»“æ„

```
/home/cv_model/
â”œâ”€â”€ training.py                    # ä¸»è®­ç»ƒæ–‡ä»¶ï¼ˆå·²æ›´æ–°ï¼‰
â”œâ”€â”€ base_model.py                  # æ¨¡å‹å®šä¹‰ï¼ˆå·²æ›´æ–°ï¼‰
â”œâ”€â”€ integrated_training.py         # å®Œæ•´é›†æˆè®­ç»ƒè„šæœ¬
â”œâ”€â”€ start_training.py              # å¿«é€Ÿå¯åŠ¨è„šæœ¬
â”œâ”€â”€ inference.py                   # æ¨ç†è„šæœ¬
â”œâ”€â”€ DeepFashion/                   # DeepFashionæ•°æ®é›†ï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ fabric/                        # Fabricçº¹ç†æ•°æ®é›†
â”‚   â””â”€â”€ train/
â”‚       â”œâ”€â”€ canvas/
â”‚       â”œâ”€â”€ denim/
â”‚       â””â”€â”€ ...
â””â”€â”€ fiber/                         # Fiberçº¤ç»´æ•°æ®é›†
    â””â”€â”€ train/
        â”œâ”€â”€ cotton/
        â”œâ”€â”€ silk/
        â””â”€â”€ ...
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1: ä½¿ç”¨æ›´æ–°çš„training.pyï¼ˆæ¨èï¼‰

```bash
# è¿è¡Œå®Œæ•´èåˆè®­ç»ƒ
python training.py --integrated
```

### æ–¹æ³•2: ä½¿ç”¨é›†æˆè®­ç»ƒè„šæœ¬

```bash
# ä½¿ç”¨å®Œæ•´çš„é›†æˆè®­ç»ƒè„šæœ¬
python integrated_training.py
```

### æ–¹æ³•3: ä½¿ç”¨å¿«é€Ÿå¯åŠ¨è„šæœ¬

```bash
# ä½¿ç”¨å¿«é€Ÿå¯åŠ¨è„šæœ¬ï¼ˆåŒ…å«ç¯å¢ƒæ£€æŸ¥ï¼‰
python start_training.py
```

## ğŸ“Š è®­ç»ƒé…ç½®

### é»˜è®¤é…ç½®
- **æ‰¹æ¬¡å¤§å°**: 32
- **å­¦ä¹ ç‡**: 1e-4
- **è®­ç»ƒè½®æ•°**: 30
- **æ··åˆç­–ç•¥**: balanced
- **æ•°æ®é›†æƒé‡**: DeepFashion(0.4), Fabric(0.3), Fiber(0.3)

### è‡ªå®šä¹‰é…ç½®
å¯ä»¥é€šè¿‡ä¿®æ”¹ `training.py` ä¸­çš„ `run_integrated_training()` å‡½æ•°æ¥è°ƒæ•´é…ç½®ï¼š

```python
# ä¿®æ”¹æ··åˆæƒé‡
mixed_train = MixedDataset(
    deepfashion_dataset=datasets.get('deepfashion_train'),
    fabric_dataset=datasets.get('fabric_train'),
    fiber_dataset=datasets.get('fiber_train'),
    mixing_strategy='balanced',
    deepfashion_weight=0.5,  # è°ƒæ•´æƒé‡
    fabric_weight=0.25,
    fiber_weight=0.25
)

# ä¿®æ”¹è®­ç»ƒå‚æ•°
trainer.train(epochs=50, save_dir="custom_checkpoints")
```

## ğŸ” æ•°æ®é›†è¦æ±‚

### å¿…éœ€æ•°æ®é›†
è‡³å°‘éœ€è¦ä»¥ä¸‹æ•°æ®é›†ä¹‹ä¸€ï¼š
- **Fabricæ•°æ®é›†**: `/home/cv_model/fabric/train/`
- **Fiberæ•°æ®é›†**: `/home/cv_model/fiber/train/`
- **DeepFashionæ•°æ®é›†**: `/home/cv_model/DeepFashion/`

### æ•°æ®é›†ç»“æ„

#### Fabric/Fiberæ•°æ®é›†
```
fabric/train/
â”œâ”€â”€ canvas/
â”‚   â”œâ”€â”€ image1.jpg
â”‚   â”œâ”€â”€ image2.jpg
â”‚   â””â”€â”€ ...
â”œâ”€â”€ denim/
â”‚   â”œâ”€â”€ image1.jpg
â”‚   â””â”€â”€ ...
â””â”€â”€ ...
```

#### DeepFashionæ•°æ®é›†
```
DeepFashion/Category and Attribute Prediction Benchmark/
â”œâ”€â”€ Img/img/                       # å›¾åƒæ–‡ä»¶
â””â”€â”€ Anno_fine/                     # æ ‡æ³¨æ–‡ä»¶
    â”œâ”€â”€ train.txt
    â”œâ”€â”€ train_attr.txt
    â”œâ”€â”€ val.txt
    â””â”€â”€ val_attr.txt
```

## ğŸ“ˆ è®­ç»ƒè¿‡ç¨‹

### 1. ç¯å¢ƒæ£€æŸ¥
- æ£€æŸ¥å¿…è¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- æ£€æµ‹å¯ç”¨çš„æ•°æ®é›†
- éªŒè¯æ•°æ®é›†ç»“æ„

### 2. æ•°æ®åŠ è½½
- è‡ªåŠ¨åŠ è½½å¯ç”¨çš„æ•°æ®é›†
- åˆ›å»ºæ··åˆæ•°æ®é›†
- è®¾ç½®æ•°æ®å¢å¼º

### 3. æ¨¡å‹åˆ›å»º
- æ ¹æ®æ•°æ®é›†åŠ¨æ€è°ƒæ•´æ¨¡å‹å‚æ•°
- è‡ªåŠ¨æ£€æµ‹ç±»åˆ«æ•°é‡
- åˆå§‹åŒ–å¤šä»»åŠ¡å­¦ä¹ æ¶æ„

### 4. è®­ç»ƒæ‰§è¡Œ
- å¤šä»»åŠ¡æŸå¤±è®¡ç®—
- åŠ¨æ€æƒé‡å¹³è¡¡
- æ—©åœå’Œæ¨¡å‹ä¿å­˜

## ğŸ“‹ è®­ç»ƒè¾“å‡º

### æ—¥å¿—ä¿¡æ¯
```
2025-10-23 10:00:00 - INFO - ================================================================================
2025-10-23 10:00:00 - INFO - å¼€å§‹å®Œæ•´èåˆçš„æ··åˆæ•°æ®é›†è®­ç»ƒ
2025-10-23 10:00:00 - INFO - ================================================================================
2025-10-23 10:00:00 - INFO - âœ“ Fabricæ•°æ®é›†å¯ç”¨
2025-10-23 10:00:00 - INFO - âœ“ Fiberæ•°æ®é›†å¯ç”¨
2025-10-23 10:00:00 - INFO - å¯ç”¨æ•°æ®é›†: ['Fabric', 'Fiber']
2025-10-23 10:00:00 - INFO - FabricåŠ è½½æˆåŠŸ: è®­ç»ƒ45000, éªŒè¯45000
2025-10-23 10:00:00 - INFO - Fabricç±»åˆ«: ['canvas', 'denim', 'lace', ...]
2025-10-23 10:00:00 - INFO - æ··åˆæ•°æ®é›†åˆ›å»ºæˆåŠŸ:
2025-10-23 10:00:00 - INFO -   è®­ç»ƒé›†æ€»é•¿åº¦: 45000
2025-10-23 10:00:00 - INFO -   fabric: é•¿åº¦=45000, æƒé‡=0.3
2025-10-23 10:00:00 - INFO - æ¨¡å‹åˆ›å»ºæˆåŠŸï¼Œå‚æ•°æ•°é‡: 25,678,432
```

### è®­ç»ƒæŒ‡æ ‡
```
Epoch 1/30
è®­ç»ƒæŒ‡æ ‡:
- total_loss: 2.1234
- attr_loss: 1.5678
- textile_loss: 0.5556

éªŒè¯æŒ‡æ ‡:
- attr_acc: 0.7234
- seg_iou: 0.0000
```

### ä¿å­˜æ–‡ä»¶
- **æ¨¡å‹æ–‡ä»¶**: `integrated_checkpoints/best_model.pth`
- **è®­ç»ƒæ—¥å¿—**: `integrated_training.log`
- **é…ç½®æ–‡ä»¶**: `integrated_checkpoints/training_config.json`

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ•°æ®é›†è·¯å¾„é”™è¯¯**
   ```
   é”™è¯¯: æ²¡æœ‰å¯ç”¨çš„æ•°æ®é›†ï¼è¯·æ£€æŸ¥æ•°æ®è·¯å¾„ã€‚
   è§£å†³: ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªæ•°æ®é›†è·¯å¾„æ­£ç¡®
   ```

2. **å†…å­˜ä¸è¶³**
   ```
   é”™è¯¯: CUDA out of memory
   è§£å†³: å‡å°batch_sizeæˆ–ä½¿ç”¨CPUè®­ç»ƒ
   ```

3. **æ¨¡å—å¯¼å…¥å¤±è´¥**
   ```
   é”™è¯¯: No module named 'base_model'
   è§£å†³: ç¡®ä¿åœ¨æ­£ç¡®çš„ç›®å½•ä¸‹è¿è¡Œè„šæœ¬
   ```

### è°ƒè¯•æ¨¡å¼

```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
export PYTHONPATH=/home/cv_model:$PYTHONPATH
python -u training.py --integrated 2>&1 | tee training.log
```

## ğŸ›ï¸ é«˜çº§é…ç½®

### 1. ä¿®æ”¹æ··åˆç­–ç•¥

```python
# åœ¨ run_integrated_training() ä¸­ä¿®æ”¹
mixed_train = MixedDataset(
    # ...
    mixing_strategy='weighted',  # 'balanced', 'weighted', 'sequential'
    # ...
)
```

### 2. è°ƒæ•´æ¨¡å‹æ¶æ„

```python
model = FullModel(
    num_classes=26,
    gat_dims=[2048, 1024, 512],  # å¢åŠ GATå±‚
    gat_heads=12,                # å¢åŠ æ³¨æ„åŠ›å¤´æ•°
    # ...
)
```

### 3. è‡ªå®šä¹‰æŸå¤±æƒé‡

```python
trainer = MixedDatasetTrainer(
    # ...
    learning_rate=5e-5,  # è°ƒæ•´å­¦ä¹ ç‡
    # ...
)
```

## ğŸ“Š æ€§èƒ½ç›‘æ§

### 1. è®­ç»ƒç›‘æ§
- å®æ—¶æŸå¤±æ›²çº¿
- éªŒè¯æŒ‡æ ‡è·Ÿè¸ª
- æ—©åœæœºåˆ¶

### 2. èµ„æºç›‘æ§
```bash
# ç›‘æ§GPUä½¿ç”¨
nvidia-smi -l 1

# ç›‘æ§ç³»ç»Ÿèµ„æº
htop
```

### 3. æ—¥å¿—åˆ†æ
```bash
# æŸ¥çœ‹è®­ç»ƒè¿›åº¦
tail -f integrated_training.log

# åˆ†æé”™è¯¯
grep "ERROR" integrated_training.log
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. æ•°æ®å‡†å¤‡
- ç¡®ä¿æ•°æ®é›†ç»“æ„æ­£ç¡®
- æ£€æŸ¥å›¾åƒæ–‡ä»¶å®Œæ•´æ€§
- å¹³è¡¡å„ç±»åˆ«æ ·æœ¬æ•°é‡

### 2. è®­ç»ƒä¼˜åŒ–
- ä»å°çš„epochæ•°å¼€å§‹æµ‹è¯•
- ç›‘æ§éªŒè¯æŒ‡æ ‡é¿å…è¿‡æ‹Ÿåˆ
- å®šæœŸä¿å­˜æ£€æŸ¥ç‚¹

### 3. èµ„æºç®¡ç†
- åˆç†è®¾ç½®batch_size
- ä½¿ç”¨å¤šè¿›ç¨‹æ•°æ®åŠ è½½
- åŠæ—¶æ¸…ç†GPUå†…å­˜

## ğŸ”„ ç»§ç»­è®­ç»ƒ

å¦‚æœéœ€è¦ä»æ£€æŸ¥ç‚¹ç»§ç»­è®­ç»ƒï¼š

```python
# åŠ è½½å·²ä¿å­˜çš„æ¨¡å‹
model = torch.load('integrated_checkpoints/best_model.pth')

# ç»§ç»­è®­ç»ƒ
trainer = MixedDatasetTrainer(model, train_loader, val_loader)
trainer.train(epochs=20, save_dir="continued_checkpoints")
```

## ğŸ“ æ€»ç»“

é€šè¿‡è¿™ä¸ªå®Œæ•´èåˆçš„è®­ç»ƒç³»ç»Ÿï¼Œæ‚¨å¯ä»¥ï¼š

1. **çµæ´»ä½¿ç”¨æ•°æ®é›†**: æ”¯æŒä»»æ„ç»„åˆçš„æ•°æ®é›†
2. **æ™ºèƒ½è®­ç»ƒç®¡ç†**: è‡ªåŠ¨æ£€æµ‹å’Œé…ç½®
3. **å¤šä»»åŠ¡å­¦ä¹ **: åŒæ—¶è®­ç»ƒå¤šä¸ªç›¸å…³ä»»åŠ¡
4. **å®Œæ•´çš„å·¥å…·é“¾**: ä»æ•°æ®åŠ è½½åˆ°æ¨¡å‹ä¿å­˜çš„å®Œæ•´æµç¨‹

ç³»ç»Ÿå·²ç»å®Œå…¨é›†æˆåˆ°ç°æœ‰çš„ `training.py` æ–‡ä»¶ä¸­ï¼Œæ‚¨å¯ä»¥ç›´æ¥ä½¿ç”¨ `python training.py --integrated` å¼€å§‹è®­ç»ƒï¼
